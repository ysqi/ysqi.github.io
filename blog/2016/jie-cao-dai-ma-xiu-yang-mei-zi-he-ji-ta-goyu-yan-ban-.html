<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>节操代码修养妹子和其他(Go语言版) - 虞双齐的博客</title><link rel="alternate" hreflang="zh" href="https://yushuangqi.com"><meta name="renderer" content="webkit"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="MobileOptimized" content="width"><meta name="HandheldFriendly" content="true"><meta name="applicable-device" content="pc,mobile"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="theme-color" content="#f8f5ec"><meta name="msapplication-navbutton-color" content="#f8f5ec"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec"><meta name="mobile-web-app-capable" content="yes"><meta name="author" content="虞双齐"><meta name="description" content="Festival &amp;amp; Fuck, Coding, Inner depth, Sister and Others. 某些文章会提到《为什么Go语言这么不受待见》，《真的没必要浪费心思在 Go 语言上》，《我为什么放弃Go语言》，《Why worse is be"><meta name="keywords" content="智能合约开发, Go语言, 区块链技术"><meta name="generator" content="Hugo 0.37.1"><link rel="canonical" href="https://yushuangqi.com/blog/2016/jie-cao-dai-ma-xiu-yang-mei-zi-he-ji-ta-goyu-yan-ban-.html"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="icon" href="/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link href="/dist/jane.min.css?v=2.7.0" rel="stylesheet"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous"><meta property="og:title" content="节操代码修养妹子和其他(Go语言版)"><meta property="og:description" content="Festival &amp; Fuck, Coding, Inner depth, Sister and Others. 某些文章会提到《为什么Go语言这么不受待见》，《真的没必要浪费心思在 Go 语言上》，《我为什么放弃Go语言》，《Why worse is be"><meta property="og:type" content="article"><meta property="og:url" content="https://yushuangqi.com/blog/2016/jie-cao-dai-ma-xiu-yang-mei-zi-he-ji-ta-goyu-yan-ban-.html"><meta property="article:published_time" content="2016-12-31T11:33:14&#43;08:00"><meta property="article:modified_time" content="2016-12-31T11:33:14&#43;08:00"><meta itemprop="name" content="节操代码修养妹子和其他(Go语言版)"><meta itemprop="description" content="Festival &amp; Fuck, Coding, Inner depth, Sister and Others. 某些文章会提到《为什么Go语言这么不受待见》，《真的没必要浪费心思在 Go 语言上》，《我为什么放弃Go语言》，《Why worse is be"><meta itemprop="datePublished" content="2016-12-31T11:33:14&#43;08:00"><meta itemprop="dateModified" content="2016-12-31T11:33:14&#43;08:00"><meta itemprop="wordCount" content="2016"><meta itemprop="keywords" content="golang,"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="节操代码修养妹子和其他(Go语言版)"><meta name="twitter:description" content="Festival &amp; Fuck, Coding, Inner depth, Sister and Others. 某些文章会提到《为什么Go语言这么不受待见》，《真的没必要浪费心思在 Go 语言上》，《我为什么放弃Go语言》，《Why worse is be"><!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]--><!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]--></head><body><div id="mobile-navbar" class="mobile-navbar"><div class="mobile-header-logo"><a href="/" class="logo">虞双齐的博客</a></div><div class="mobile-navbar-icon"><span></span> <span></span> <span></span></div></div><nav id="mobile-menu" class="mobile-menu slideout-menu"><ul class="mobile-menu-list"><a href="/"><li class="mobile-menu-item">首页</li></a><a href="/series.html"><li class="mobile-menu-item">专题</li></a><a href="/categories.html"><li class="mobile-menu-item">分类</li></a><a href="/tags.html"><li class="mobile-menu-item">标签</li></a><a href="/post.html"><li class="mobile-menu-item">归档</li></a><a href="/about.html"><li class="mobile-menu-item">关于</li></a></ul></nav><header id="header" class="header container"><div class="logo-wrapper"><a href="/" class="logo">虞双齐的博客</a></div><nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item"><a class="menu-item-link" href="/">首页</a></li><li class="menu-item"><a class="menu-item-link" href="/series.html">专题</a></li><li class="menu-item"><a class="menu-item-link" href="/categories.html">分类</a></li><li class="menu-item"><a class="menu-item-link" href="/tags.html">标签</a></li><li class="menu-item"><a class="menu-item-link" href="/post.html">归档</a></li><li class="menu-item"><a class="menu-item-link" href="/about.html">关于</a></li></ul></nav></header><div id="mobile-panel"><main id="main" class="main bg-llight"><div class="content-wrapper"><div id="content" class="content container"><article class="post bg-white"><header class="post-header"><h1 class="post-title">节操代码修养妹子和其他(Go语言版)</h1><div class="post-meta"><span class="post-time">2016-12-31</span><div class="post-category"><a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E4%B8%8E%E5%BC%80%E5%8F%91.html">编程语言与开发</a></div><span class="more-meta">约 2016 字 </span><span class="more-meta">预计阅读 5 分钟</span></div></header><div class="post-toc" id="post-toc"><h2 class="post-toc-title">文章目录</h2><div class="post-toc-content always-active"><nav id="TableOfContents"><ul><li><ul><li><ul><li><a href="#类-对象-属性-可能还夹杂着一点设计模式">类、对象、属性，可能还夹杂着一点设计模式</a></li><li><a href="#至于defer和panic">至于defer和panic</a></li><li><a href="#err的一种处理方式">err的一种处理方式</a></li></ul></li></ul></li></ul></nav></div></div><div class="post-content"><p>Festival &amp; Fuck, Coding, Inner depth, Sister and Others.</p><p>某些文章会提到《为什么Go语言这么不受待见》，《真的没必要浪费心思在 Go 语言上》，《我为什么放弃Go语言》，《Why worse is better》等话题。经常重温这些话题，每次都会有新发现。最忌手里有了一个语言，心里便容不下另一个语言。</p><p>忽略细节、语法或者设计，Go语言各种好用。考虑到这些因素，Go被喷出翔都不为过。</p><p>本文不打算在细节、语法或者设计上扯淡，只举些例子，说一说如何用Go语言写出还凑合的代码。</p><h3 id="类-对象-属性-可能还夹杂着一点设计模式">类、对象、属性，可能还夹杂着一点设计模式</h3><pre><code>//代码来自 https://github.com/xgdapg/xconn/blob/master/xconn.go，已验证

//Conn 对应一个tcp连接
type Conn struct {
        //原生TCP连接
    conn         net.Conn
        //发送数据的channel（类似队列）
    send         chan *MsgData
        //消息处理方法
    msgHandler   MsgHandler
        //tcp缓冲区
    recvBuffer   []byte
        //消息一次封装，后续会进行二次封装
    msgPacker    MsgPacker
        //健康检查周期
    pingInterval uint
        //健康检查方法
    pingHandler  PingHandler
        //停止健康检查channel
    pingStop     chan bool
        //自定义关闭连接时所调用方法
    closeHandler CloseHandler
}

//MsgHandler 为自定义处理消息
type MsgHandler interface {
    HandleMsg(*MsgData)
}

//MsgPacker 为自定义拆包解包方式，为了性能可以直接将此段与recvLoop端合并
type MsgPacker interface {
    PackMsg(*MsgData) []byte
    UnpackMsg([]byte) *MsgData
}

//MsgData 自定义消息类型
type MsgData struct {
    Data []byte
    Ext  interface{}
}

//PingHandler 为自定义心跳命令
type PingHandler interface {
    HandlePing()
}

//CloseHandler 为连接断开时的自定义操作
type CloseHandler interface {
    HandleClose()
}

//NewConn 为处理新连接方式：启动两个协程，一个只负责读，一个只负责写，
//也可以认为开启了三个协程，第三个协程负责进行定时ping操作
func NewConn(conn net.Conn) *Conn {
    c := &amp;Conn{
        conn:         conn,
        send:         make(chan *MsgData, 64),
        msgHandler:   nil,
        recvBuffer:   []byte{},
        msgPacker:    nil,
        pingInterval: 0,
        pingHandler:  nil,
        pingStop:     nil,
        closeHandler: nil,
    }

    go c.recvLoop()
    go c.sendLoop()

    return c
}

//recoverPanic 程序panic情况下的处理方法（例如向已经关闭的tcp连接写数据会造成panic）
func recoverPanic() {
    if err := recover(); err != nil {
        //fmt.Println(err)
    }
}

//SetMsgHandler 为 Getter Setter 方法
func (this *Conn) SetMsgHandler(hdlr MsgHandler) {
    this.msgHandler = hdlr
}

//SetMsgPacker 为 Getter Setter 方法
func (this *Conn) SetMsgPacker(packer MsgPacker) {
    this.msgPacker = packer
}

//SetPing 为 Getter Setter 方法
func (this *Conn) SetPing(sec uint, hdlr PingHandler) {
    this.pingInterval = sec
    this.pingHandler = hdlr
    if this.pingStop == nil {
        this.pingStop = make(chan bool)
    }
    if sec &gt; 0 {
        go this.pingLoop()
    }
}

//SetCloseHandler 为 Getter Setter 方法
func (this *Conn) SetCloseHandler(hdlr CloseHandler) {
    this.closeHandler = hdlr
}

//pingLoop 为定时健康检查操作
func (this *Conn) pingLoop() {
    defer recoverPanic()
    for {
        select {
        case &lt;-this.pingStop:
            return
        case &lt;-time.After(time.Duration(this.pingInterval) * time.Second):
            this.Ping()
        }
    }
}

//RawConn 返回原始的tcp连接
func (this *Conn) RawConn() net.Conn {
    return this.conn
}

//recvLoop 用于处理接收到的tcp包，并进行拆包等操作，然后调用recvMsg方法进行处理
func (this *Conn) recvLoop() {
    defer recoverPanic()
    defer this.Close()
    buffer := make([]byte, 2048)
        //一次封包协议：四个字节（int32）表示包长度，根据包长度截取消息长度作为包。
    for {
        bytesRead, err := this.conn.Read(buffer)
        if err != nil {
            return
        }

        this.recvBuffer = append(this.recvBuffer, buffer[0:bytesRead]...)
        for len(this.recvBuffer) &gt; 4 {
            length := binary.BigEndian.Uint32(this.recvBuffer[0:4])
            readToPtr := length + 4
            if uint32(len(this.recvBuffer)) &lt; readToPtr {
                break
            }
            if length == 0 {
                if this.pingHandler != nil {
                    this.pingHandler.HandlePing()
                }
            } else {
                buf := this.recvBuffer[4:readToPtr]
                go this.recvMsg(buf)
            }
            this.recvBuffer = this.recvBuffer[readToPtr:]
        }
    }
}

//recvMsg 为代理，实际执行的是后台的HandleMsg方法。
func (this *Conn) recvMsg(data []byte) {
    defer recoverPanic()
    msg := &amp;MsgData{
        Data: data,
        Ext:  nil,
    }
        //调用UnackMsg对信息进行二次解包
    if this.msgPacker != nil {
        msg = this.msgPacker.UnpackMsg(data)
    }
    if this.msgHandler != nil {
        this.msgHandler.HandleMsg(msg)
    }
}

//sendLoop 用于发送数据包
func (this *Conn) sendLoop() {
    defer recoverPanic()
    for {
        msg, ok := &lt;-this.send
        if !ok {
            break
        }

        go this.sendMsg(msg)
    }
}

//sendMsg 用于发送数据包，实际先调用PackMsg进行信息持久化，然后二次封包，转换为本框架能接受的形式
func (this *Conn) sendMsg(msg *MsgData) {
    defer recoverPanic()
    sendBytes := make([]byte, 4)
    if msg != nil {
        data := msg.Data
        if this.msgPacker != nil {
            data = this.msgPacker.PackMsg(msg)
        }
        length := len(data)
        binary.BigEndian.PutUint32(sendBytes, uint32(length))
        sendBytes = append(sendBytes, data...)
    }
    this.conn.Write(sendBytes)
}

//Close 关闭连接
func (this *Conn) Close() {
    defer recoverPanic()
    this.conn.Close()
    close(this.send)
    if this.pingStop != nil {
        close(this.pingStop)
    }
    if this.closeHandler != nil {
        this.closeHandler.HandleClose()
    }
}

//SendMsg 用于发送数据
func (this *Conn) SendMsg(msg *MsgData) {
    this.send &lt;- msg
}

//SendData 用于发送数据
func (this *Conn) SendData(data []byte) {
    this.SendMsg(&amp;MsgData{Data: data, Ext: nil})
}

//Ping 用于健康监测
func (this *Conn) Ping() {
    go this.sendMsg(nil)
}
</code></pre><p>作为一个专用于处理TCP链接的框架，实际上xconn（上文中的代码）进行了两次封装，连消息发送、信息拆包封包、甚至接收信息都进行了二次封装。</p><p>实际代码中，可以进行简化操作，将二次的部分简化为一次。</p><p>将代码写得和上面一样工整，便已经超越大部分猿了。</p><p>上个例子中作者用到了recover，用的很克制，却又恰到好处。</p><h3 id="至于defer和panic">至于defer和panic</h3><p>Go语言的try catch?</p><pre><code>import (
    &quot;fmt&quot;
    &quot;github.com/manucorporat/try&quot;
)

func main() {
    try.This(func() {
        panic(&quot;my panic&quot;)

    }).Finally(func() {
        fmt.Println(&quot;this must be printed after the catch&quot;)

    }).Catch(func(e try.E) {
        // Print crash
        fmt.Println(e)
    })
}
</code></pre><p>以上代码纯属搞笑，个人不建议工程项目中使用如此写法，但是这种做法可以借鉴。</p><p>工程代码：（用于Go与数据库Transaction）</p><pre><code>//代码来自《Go语言游戏项目应用情况汇报》

func (db *Database) Transaction(work func()) {
    db.lock.Lock()
    defer db.lock.UnLock()
    //事务控制
    defer func() {
        if err := recover; err == nil {
            db.commit(info)
        } else {
            db.rollback()
            //选择性抛出panic
            panic(TransError{err})
        }
    }()
    //执行传入的函数
    work()
}
</code></pre><p>《Go语言游戏项目应用情况汇报》是我所能找到的，为数不多的几个敢开放部分工程代码的分享。整体代码比较整洁，适于新手学习。</p><p>以上对err的处理方法写法，和《Errors are values》有异曲同工之妙。</p><h3 id="err的一种处理方式">err的一种处理方式</h3><p>示范代码：来自《Errors are vales》</p><pre><code>//这种写法强烈不推荐！！！！这就是许多人说的Go程序一大半都在check error
_, err = fd.Write(p0[a:b])
if err != nil {
    return err
}
_, err = fd.Write(p1[c:d])
if err != nil {
    return err
}
_, err = fd.Write(p2[e:f])
if err != nil {
    return err
}
// and so on
//重要的事情说两遍：不推荐，但是个人小项目这样写，完全没问题。
</code></pre><p>推荐如下写法：</p><pre><code>var err error
write := func(buf []byte) {
    if err != nil {
        return
    }
    _, err = w.Write(buf)
}
write(p0[a:b])
write(p1[c:d])
write(p2[e:f])
// and so on
if err != nil {
    return err
}
</code></pre><p>也推荐如下写法：</p><pre><code>func (ew *errWriter) write(buf []byte) {
    if ew.err != nil {
        return
    }
    _, ew.err = ew.w.Write(buf)
}
</code></pre><p>其他：</p><p>正名：为什么选择Go语言。</p><p>答：因为简单，并且也不会别的。</p><p>建议：尽量选择Go1.6及以上版本，避免GC造成程序STW。</p><p>至于GC性能，可以参考 <a href="https://www.zhihu.com/question/42353634">Go1.6中的gc pause已经完全超越JVM了吗?</a>。</p><p>原文禁止转载，因此提炼出关键字：从效果看XXX，但XXX；并且，XXX，XXX。</p><p>So, Why worse is better?</p></div><div style="height:130px"><div class="post-copyright" style="float:left"><p class="copyright-item"><span class="item-title">文章作者</span> <span class="item-content">虞双齐</span></p><p class="copyright-item"><span class="item-title">上次更新</span> <span class="item-content">2016-12-31</span></p><p class="copyright-item"><span class="item-title">许可协议</span> <span class="item-content"><a target="_blank" rel="license noopener external nofollow" href="https://creativecommons.org/licenses/by/4.0/deed.zh">署名 4.0 国际</a></span></p></div><div class="post-copyright" style="float:right"><a href="https://info.flagcounter.com/8B1z" target="_blank" rel="noopener external nofollow"><img src="https://s05.flagcounter.com/countxl/8B1z/bg_FFFFFF/txt_000000/border_CCCCCC/columns_4/maxflags_12/viewers_0/labels_0/pageviews_1/flags_0/percent_0/" alt="Flag Counter" border="0"></a></div></div><div class="post-reward"><input type="checkbox" name="reward" id="reward" hidden> <label class="reward-button" for="reward">赞赏支持</label><div class="qr-code"><label class="qr-code-image" for="reward"><img class="image" src="/img/donateMe_wechat.png"> <span>微信打赏</span></label></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/golang.html">golang</a></div><nav class="post-nav"><a class="prev" href="/blog/2016/yi-bu-yi-bu-jiao-ni-xie-btchong-zi-xiu-tan-qi-zhi-er----dhtpian.html"><i class="iconfont icon-left"></i> <span class="prev-text nav-default">一步一步教你写BT种子嗅探器之二---DHT篇</span> <span class="prev-text nav-mobile">上一篇</span> </a><a class="next" href="/blog/2016/goyu-yan-bing-fa-mo-xing-xiang-unix-pipena-yang-shi-yong-channel.html"><span class="next-text nav-default">Go语言并发模型:像UnixPipe那样使用channel</span> <span class="prev-text nav-mobile">下一篇</span> <i class="iconfont icon-right"></i></a></nav></footer><div class="disqus-button" id="load_disqus" onclick="load_disqus()">显示 Disqus 评论</div><div id="disqus_thread"></div><script type="text/javascript">function load_disqus() {
        
        
        if (window.location.hostname === 'localhost') return;

        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        var disqus_shortname = 'yushuangqi';
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);

        $('#load_disqus').remove();
    };</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></article></div></div></main><footer id="footer" class="footer"><div class="social-links"><a href="mailto:ysqi@yushuangqi.com" rel="me" class="iconfont icon-email" title="email"></a> <a href="http://github.com/ysqi" rel="me" class="iconfont icon-github" title="github"></a> <a href="https://weibo.com/234665601" rel="me" class="iconfont icon-weibo" title="weibo"></a> <a href="https://www.zhihu.com/people/_ysqi/" rel="me" class="iconfont icon-zhihu" title="zhihu"></a> <a href="https://yushuangqi.com/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a></div><div class="copyright"><span class="power-by">Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a> </span><span class="division">|</span> <span class="theme-info">Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a> </span><span class="copyright-year">&copy; 2014 - 2021 <span class="heart"><i class="iconfont icon-heart"></i> </span><span class="author">虞双齐 | <a href="https://beian.miit.gov.cn/">粤ICP备14032560号</a></span></span></div></footer><div class="back-to-top" id="back-to-top"><i class="iconfont icon-up"></i></div></div><script src="/lib/highlight/highlight.pack.js?v=20171001"></script><script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script><script type="text/javascript" src="/dist/jane.min.js?v=2.7.0"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });</script><script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script><script id="baidu_analytics">var _hmt = _hmt || [];
  (function() {
    if (window.location.hostname === 'localhost') return;
    var hm = document.createElement("script"); hm.async = true;
    hm.src = "https://hm.baidu.com/hm.js?a16b3275b071ec0efc507a05422a7156";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();</script></body></html>